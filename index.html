<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fil d'Actualit√© - Stories App</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/main.css">
	<style>
/* Ajout pour les commentaires longs */
.comment {
    word-break: break-word;
    white-space: pre-line;
    max-height: 120px;
    overflow-y: auto;
    padding-right: 8px;
}

</style>
</head>
<body>
    
    <header class="header-top">
        <div class="logo">
            <!-- remplace l'emoji par votre logo -->
            <img src="assets/logo_v9.png" alt="Thread Logo" class="site-logo">
            <span style="font-size:1.35rem; font-weight:700; color:inherit;">Thread</span>
        </div>

        <div class="profile-menu-container">
            <img id="profileAvatar" class="profile-avatar" src="assets/ImageParDefaut.png" alt="Avatar">
            <div class="profile-dropdown" id="profileDropdown">
                <a href="login.html" id="dropdownLoginLink">üîë Login</a>
                <a href="register.html" id="dropdownRegisterLink">üìù Register</a>
                <a href="profile.html" id="dropdownProfileLink" style="display:none;">üë§ My Profile</a>
                <div class="divider"></div>
                <a id="logoutBtn" class="logout-link" style="display:none;">üö™ Log Out</a>
            </div>
        </div>
    </header>

    <nav class="navbar-main">
        <a href="index.html" class="active">Home</a>
        <a href="tags.html">Tags</a>
        <a href="create_story.html" id="navCreateLink">Create</a>
        <a href="archives.html">Archives</a>
    </nav>


    <div class="app-container">
        <div class="content-area container-fluid">
            <div class="row">
                
                <div class="col-12">
                    <h1 class="mb-4 mt-3 text-primary text-center">Story Feed üìñ</h1>
                    <div id="story_feed_container">
                        <p id="loading_status" class="text-center text-muted">Loading stories...</p>
                    </div>
                </div>
                
                </div>
        </div>
    </div>


    <!-- Modal: Edit Story -->
<div class="modal fade" id="editStoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editStoryForm">
        <div class="modal-header">
          <h5 class="modal-title">Edit Story</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit_story_id" name="story_id">
          <div class="mb-3">
            <label for="edit_title" class="form-label">Title</label>
            <input type="text" id="edit_title" name="titleStory" class="form-control" required maxlength="100">
          </div>
          <div class="mb-3">
            <label for="edit_content" class="form-label">Content</label>
            <textarea id="edit_content" name="contentStory" rows="8" class="form-control" required></textarea>
          </div>
          <div id="editMessage" class="mt-2"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const TRUNCATE_LENGTH = 250; 
        
        // --- LOGIQUE D'AFFICHAGE DU MENU PROFIL ---
        $('#profileAvatar').on('click', function() {
            $('#profileDropdown').toggle();
        });
        // Cacher le menu si on clique en dehors
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.profile-menu-container').length) {
                $('#profileDropdown').hide();
            }
        });
        // --- FIN LOGIQUE DU MENU PROFIL ---
        
        $(document).ready(function() {
            const $dropdownLoginLink = $('#dropdownLoginLink');
            const $dropdownRegisterLink = $('#dropdownRegisterLink');
            const $dropdownProfileLink = $('#dropdownProfileLink');
            const $navCreateLink = $('#navCreateLink');
            const $logoutBtn = $('#logoutBtn');
            const $feedContainer = $('#story_feed_container');

            // 1. Fonction pour v√©rifier le statut de la session et mettre √† jour le menu Profil
            function checkAuthStatus() {
                $.ajax({
                    url: 'check_session.php',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.status === 'connected') {
                            // Mettre √† jour l'avatar si fourni
                            if (response.profile_pic) {
                                $('#profileAvatar').attr('src', response.profile_pic);
                            } else {
                                $('#profileAvatar').attr('src', 'assets/ImageParDefaut.png');
                            }
                            $dropdownLoginLink.hide();
                            $dropdownRegisterLink.hide();
                            $dropdownProfileLink.show();
                            $logoutBtn.show();
                            $navCreateLink.show(); // Afficher le lien "Create"
                        } else {
                            $dropdownLoginLink.show();
                            $dropdownRegisterLink.show();
                            $dropdownProfileLink.hide();
                            $logoutBtn.hide();
                            $navCreateLink.hide(); // Cacher le lien "Create"
                        }
                    }
                });
            }

            // 2. Gestion de la D√©connexion 
            function handleLogout() {
                if (confirm('Are you sure you want to log out?')) {
                    $.ajax({
                        url: 'logout.php',
                        type: 'POST',
                        dataType: 'json',
                        success: function(response) {
                            if (response.success) {
                                // Redirection forc√©e apr√®s d√©connexion pour r√©initialiser l'√©tat
                                window.location.href = 'index.html';
                            } else {
                                alert('Error during logout.');
                            }
                        }
                    });
                }
            }
            $logoutBtn.on('click', handleLogout);

            // 3. Fonction pour r√©cup√©rer et afficher les Stories
            function fetchStories() {
                $('#loading_status').text('Loading stories...');

                fetch('get_stories.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.stories.length > 0) {
                            displayStories(data.stories);
                        } else {
                            $feedContainer.html('<p class="text-center">No stories are available at the moment.</p>');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching stories:', error);
                        $feedContainer.html('<p class="text-center" style="color: red;">Error loading news feed.</p>');
                    });
            }

            // 4. Fonction pour rendre les stories en HTML
            function displayStories(stories) {
                let storiesHtml = '';

                stories.forEach(story => {
                    const tagsList = 
                        (function(){
                            // Accepte soit un tableau, soit une cha√Æne s√©par√©e par |||
                            let arr = [];
                            if (Array.isArray(story.Tags)) arr = story.Tags;
                            else if (typeof story.Tags === 'string' && story.Tags.length) arr = story.Tags.split('|||');
                            return arr.map(tag => `<span class="badge bg-warning text-dark">${tag}</span>`).join(' ');
                        })();
                        
                    const fullContent = story.Content || ''; 
                    const isLongStory = fullContent.length > TRUNCATE_LENGTH;
                    const truncatedContent = isLongStory ? fullContent.substring(0, TRUNCATE_LENGTH) : fullContent;
                    
                    storiesHtml += `
                        <div class="story-item" data-story-id="${story.IdStory}">
                            ${voteSectionHtml(story)}

                            <div class="tags-section">
                                ${tagsList}
                            </div>

                            <div class="mb-3">
                                <h3 class="text-primary">${story.StoryTitle}</h3>
                            </div>
                            
                            <p class="text-muted mb-3">Published by <strong>${story.Username}</strong></p>
                            
                            ${story.Picture ? `<img src="${story.Picture}" alt="Image of the story" class="img-fluid rounded mb-3">` : ''}
                            
                            <div class="story-content-box">
                                <p class="story-content-truncated">${truncatedContent}${isLongStory ? '...' : ''}</p>
                            
                                <p class="story-content-full" style="display:none;">${fullContent}</p>
                            </div>
                            
                            <!-- stocker data/title/content pour √©dition -->
                            <input type="hidden" class="story-title-data" value="${story.StoryTitle}">
                            <textarea class="story-content-data" style="display:none;">${fullContent}</textarea>
                            <div class="story-actions">
                                ${story.can_edit ? `<button class="edit-story-btn" data-story-id="${story.IdStory}" title="√âditer">üñäÔ∏è</button>` : ''}
                                ${story.can_delete ? `<button class="delete-story-btn" data-story-id="${story.IdStory}" title="Supprimer">üóëÔ∏è</button>` : ''}
                                ${isLongStory ? `<button class="btn btn-sm btn-outline-secondary read-more-btn" data-story-id="${story.IdStory}">Read more</button>` : ''}
                            </div>
                            
                            <span class="story-date">Published on ${new Date(story.CreationDate).toLocaleDateString()}</span>
                            ${commentBlockHtml(story.IdStory)}
                        </div>
                    `;
                });

                $('#story_feed_container').html(storiesHtml);

                // Charger les commentaires pour chaque story affich√©e
                $('.story-item').each(function() {
                    const storyId = $(this).data('story-id');
                    const $commentsSection = $(this).find('.comments-section');
                    loadComments(storyId, $commentsSection.find('.comments-list'));
                });
            }
            
            // Ajout : fonction pour g√©n√©rer la section vote
            function voteSectionHtml(story) {
                // Voting removed: do not render vote counts
                return '';
            }

                    // 5. Gestion de l'√©v√©nement "Lire la suite"
            $('#story_feed_container').on('click', '.read-more-btn', function() {
                const $btn = $(this);
                const $item = $btn.closest('.story-item');
                const $truncated = $item.find('.story-content-truncated');
                const $full = $item.find('.story-content-full');
                
                if ($full.is(":hidden")) {
                    $truncated.hide();
                    $full.show();
                    $btn.text('Show less');
                } else {
                    $truncated.show();
                    $full.hide();
                    $btn.text('Read more');
                }
            });
            
            
            // Gestion de la suppression (d√©l√©gu√©)
            $('#story_feed_container').on('click', '.delete-story-btn', function() {
                const storyId = $(this).data('story-id');
                if (!confirm('Confirm deletion of this story?')) return;
                const $btn = $(this);
                $btn.prop('disabled', true).text('Deleting...');
                $.ajax({
                    url: 'delete_story.php',
                    type: 'POST',
                    data: { story_id: storyId },
                    dataType: 'json',
                    success: function(resp) {
                        if (resp.success) {
                            $btn.closest('.story-item').slideUp(200, function(){ $(this).remove(); });
                        } else {
                            alert(resp.message || 'Error while deleting.');
                            $btn.prop('disabled', false).text('Delete');
                        }
                    },
                    error: function() {
                        alert('Server error while deleting.');
                        $btn.prop('disabled', false).text('Delete');
                    }
                });
            });
            
            // Ouvrir modal d'√©dition
            $(document).on('click', '.edit-story-btn', function() {
                const $card = $(this).closest('.story-item');
                const id = $(this).data('story-id');
                const title = $card.find('.story-title-data').val() || $card.find('h3').text();
                const content = $card.find('.story-content-data').text() || $card.find('.story-content-full').text();
                $('#edit_story_id').val(id);
                $('#edit_title').val(title);
                $('#edit_content').val(content);
                $('#editMessage').empty();
                var modal = new bootstrap.Modal(document.getElementById('editStoryModal'));
                modal.show();
            });

            // Soumettre modification
            $('#editStoryForm').on('submit', function(e){
                e.preventDefault();
                const $form = $(this);
                const $btn = $form.find('button[type="submit"]');
                const data = $form.serialize();
                $btn.prop('disabled', true).text('Enregistrement...');
                $('#editMessage').removeClass().text('');
                $.ajax({
                    url: 'update_story.php',
                    type: 'POST',
                    data: data,
                    dataType: 'json',
                    success: function(resp){
                        if (resp.success) {
                            // fermer modal et recharger les stories
                            bootstrap.Modal.getInstance(document.getElementById('editStoryModal')).hide();
                            // recharge la liste pour simplicit√©
                            fetchStories();
                        } else {
                            $('#editMessage').addClass('text-danger').text(resp.message || 'Error updating.');
                        }
                    },
                    error: function(xhr){
                        $('#editMessage').addClass('text-danger').text('Server error.');
                    },
                    complete: function(){
                        $btn.prop('disabled', false).text('Enregistrer');
                    }
                });
            });
            
            // Ajout : fonction pour charger les commentaires d'une story
            function loadComments(storyId, $commentsContainer) {
                $.ajax({
                    url: 'get_comments.php',
                    type: 'GET',
                    data: { story_id: storyId },
                    dataType: 'json',
                    success: function(resp) {
                        if (resp.success && resp.comments.length > 0) {
                            let html = '';
                            resp.comments.forEach(function(c) {
                                html += `<div class="comment mb-1" data-comment-id="${c.IdComment}">
                                    <strong>${c.Username}</strong> : <span>${$('<div>').text(c.Content).html()}</span>
                                    <span class="text-muted" style="font-size:0.85em;">${c.CreationDate}</span>
                                    ${c.can_delete ? `<button class="delete-comment-btn btn btn-link btn-sm text-danger p-0 ms-2" title="Supprimer" style="font-size:0.95em;">üóëÔ∏è</button>` : ''}
                                </div>`;
                            });
                            $commentsContainer.html(html);
                        } else {
                            $commentsContainer.html('<div class="text-muted">No comments.</div>');
                        }
                    },
                    error: function() {
                        $commentsContainer.html('<div class="text-danger">Error loading comments.</div>');
                    }
                });
            }

            // Ajout : fonction pour afficher le bloc commentaire sous chaque story
            function commentBlockHtml(storyId) {
                return `
                    <div class="comments-section" data-story-id="${storyId}">
                        <div class="comments-list mb-2" style="min-height:24px;"></div>
                        <form class="add-comment-form d-flex gap-2" autocomplete="off">
                            <input type="text" name="contentComment" class="form-control form-control-sm" placeholder="Add a comment..." maxlength="500" required>
                            <button type="submit" class="btn btn-sm btn-primary">Send</button>
                        </form>
                        <div class="comment-message mt-1" style="font-size:0.95em;"></div>
                    </div>
                `;
            }


            
            // Gestion de l'ajout de commentaire (d√©l√©gu√©)
            $('#story_feed_container').on('submit', '.add-comment-form', function(e) {
                e.preventDefault();
                const $form = $(this);
                const $section = $form.closest('.comments-section');
                const $msg = $section.find('.comment-message');
                const $input = $form.find('input[name="contentComment"]');
                const content = $input.val();
                const storyId = $section.data('story-id');
                $msg.removeClass('text-danger text-success').text('');
                $form.find('button').prop('disabled', true);

                $.ajax({
                    url: 'add_comment.php',
                    type: 'POST',
                    data: { story_id: storyId, contentComment: content },
                    dataType: 'json',
                    success: function(resp) {
                        if (resp.success) {
                            $input.val('');
                            loadComments(storyId, $section.find('.comments-list'));
                        } else {
                            $msg.addClass('text-danger').text(resp.message || 'Error.');
                        }
                    },
                    error: function(xhr) {
                        if (xhr.status === 401) {
                            $msg.addClass('text-danger').text('You must be logged in to comment.');
                        } else {
                            $msg.addClass('text-danger').text('Server error.');
                        }
                    },
                    complete: function() {
                        $form.find('button').prop('disabled', false);
                    }
                });
            });
            
            // Gestion de la suppression de commentaire (d√©l√©gu√©)
            $('#story_feed_container').on('click', '.delete-comment-btn', function(e) {
                e.preventDefault();
                const $commentDiv = $(this).closest('.comment');
                const commentId = $commentDiv.data('comment-id');
                if (!confirm('Delete this comment?')) return;
                $(this).prop('disabled', true);
                $.ajax({
                    url: 'delete_comment.php',
                    type: 'POST',
                    data: { comment_id: commentId },
                    dataType: 'json',
                    success: function(resp) {
                        if (resp.success) {
                            $commentDiv.slideUp(150, function(){ $(this).remove(); });
                        } else {
                            alert(resp.message || 'Error deleting the comment.');
                            $(this).prop('disabled', false);
                        }
                    },
                    error: function() {
                        alert('Server error while deleting the comment.');
                        $(this).prop('disabled', false);
                    }
                });
            });

            // Lancement des fonctions au chargement de la page
            checkAuthStatus();
            fetchStories();
        });
    </script>
</body>
</html>