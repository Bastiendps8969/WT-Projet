<!DOCTYPE html>
<html lang="en">
<!--
    Fichier : create_story.html
    R√¥le : Page front-end permettant √† un utilisateur authentifi√© de cr√©er une nouvelle "Story".
    Contenu : Formulaire de cr√©ation (titre, contenu, image, tags), gestion de l'aper√ßu d'image,
                        chargement des tags via AJAX, et soumission du formulaire en AJAX vers `add_story.php`.
-->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create a Story</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
	
	<header class="header-top">
		<div class="logo">
			<img src="assets/logo_v9.png" alt="Thread Logo" class="site-logo">
			<span style="font-size:1.35rem; font-weight:700; color:inherit;">Thread</span>
		</div>

		<div class="profile-menu-container">
			<img id="profileAvatar" class="profile-avatar" src="assets/ImageParDefaut.png" alt="Avatar">
			<div class="profile-dropdown" id="profileDropdown">
                <a href="login.html" id="dropdownLoginLink">üîë Login</a>
                <a href="register.html" id="dropdownRegisterLink">üìù Register</a>
                <a href="profile.html" id="dropdownProfileLink" style="display:none;">üë§ My Profile</a>
				<div class="divider"></div>
                <a id="logoutBtn" class="logout-link" style="display:none;">üö™ Log Out</a>
			</div>
		</div>
	</header>

	<nav class="navbar-main">
		<a href="index.html">Home</a>
		<a href="tags.html">Tags</a>
		<a href="create_story.html" id="navCreateLink" class="active">Create</a> 
        <a href="archives.html">Archives</a>
	</nav>


	<div class="container">
        <h1 class="mb-4 text-center">‚úçÔ∏è Create a New Story</h1>
		
		<form id="createStoryForm" enctype="multipart/form-data">
			
			<div class="mb-3 form-group">
                <label for="title" class="form-label">Story Title</label>
                <input type="text" class="form-control" id="title" name="titleStory" maxlength="50" required>
                <div class="form-text">Maximum 50 characters.</div>
			</div>

			<div class="mb-3 form-group">
                <label for="tags" class="form-label">Tags (Select at least one)</label>
                <select class="form-select" id="tags" name="tagStory[]" multiple>
                    <option value="" disabled>Loading tags...</option>
				</select>
                <div class="form-text">Use CTRL/CMD to select multiple tags.</div>
			</div>

            <div class="mb-3 form-group">
                <label for="content" class="form-label">Story Content</label>
                <textarea class="form-control" id="content" name="contentStory" rows="8" maxlength="5000" required></textarea>
                <div class="form-text">Maximum 5000 characters.</div>
            </div>

            <div class="mb-3 form-group">
                <label for="picture" class="form-label">Story Image (Optional)</label>
                <input class="form-control" type="file" id="picture" name="pictureStory" accept="image/png, image/jpeg, image/gif">
                <img id="previewImage" src="#" alt="Image preview" style="display:none;"/>
            </div>


			<div id="messageArea" class="mt-4 alert" style="display:none;"></div>

			<div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg">üöÄ Publish Story</button>
			</div>
		</form>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		
        // --- LOGIQUE D'AFFICHAGE DU MENU PROFIL ---
        // Ce bloc g√®re l'ouverture/fermeture du menu profil lorsque l'utilisateur clique
        // sur l'avatar, et cache le menu si l'utilisateur clique en dehors.
        $('#profileAvatar').on('click', function() { $('#profileDropdown').toggle(); });
        // Cacher le menu si on clique en dehors
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.profile-menu-container').length) {
                $('#profileDropdown').hide();
            }
        });
        // --- FIN LOGIQUE DU MENU PROFIL ---
        
        $(document).ready(function() {
            const $dropdownLoginLink = $('#dropdownLoginLink');
            const $dropdownRegisterLink = $('#dropdownRegisterLink');
            const $dropdownProfileLink = $('#dropdownProfileLink');
            const $navCreateLink = $('#navCreateLink');
            const $logoutBtn = $('#logoutBtn');
            
            /*
             * V√©rifie le statut de la session sur le serveur via `check_session.php`.
             * - Si l'utilisateur est connect√©, met √† jour l'avatar et les liens du menu.
             * - Si non connect√©, redirige vers la page de connexion (s√©curit√© c√¥t√© client).
             * Remarque : la v√©rification finale des droits doit √™tre faite c√¥t√© serveur
             * pour chaque op√©ration sensible.
             */
            function checkAuthStatus() {
                $.ajax({
                    url: 'check_session.php',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.status === 'connected') {
                            if (response.profile_pic) {
                                $('#profileAvatar').attr('src', response.profile_pic);
                            } else {
                                $('#profileAvatar').attr('src', 'assets/ImageParDefaut.png');
                            }
                            // Connect√©
                            $dropdownLoginLink.hide();
                            $dropdownRegisterLink.hide();
                            $dropdownProfileLink.show();
                            $logoutBtn.show();
                            $navCreateLink.show(); 
                        } else {
                            // D√©connect√© - Rediriger si non connect√© et sur la page de cr√©ation
                            alert('You must be logged in to create a story.');
                            window.location.href = 'login.html'; 
                        }
                    },
                    error: function() {
                        // En cas d'erreur durant la v√©rification, rediriger vers login
                        window.location.href = 'login.html';
                    }
                });
            }

            /*
             * D√©connexion de l'utilisateur : confirme l'action, appelle `logout.php` en POST
             * et redirige vers la page d'accueil en cas de succ√®s.
             */
            function handleLogout() {
                if (confirm('Are you sure you want to log out?')) {
                    $.ajax({
                        url: 'logout.php',
                        type: 'POST',
                        dataType: 'json',
                        success: function(response) {
                            if (response.success) {
                                window.location.href = 'index.html';
                            } else {
                                alert('Error during logout.');
                            }
                        },
                        error: function() {
                            alert('Error during logout.');
                        }
                    });
                }
            }
            $logoutBtn.on('click', handleLogout);

            // Tags are required for publishing stories

            /*
             * Charge la liste des tags disponibles depuis `get_tags.php` en JSON,
             * puis remplit le select `#tags`. En cas d'erreur, affiche une option d√©sactiv√©e.
             */
            function loadTags() {
                $.ajax({
                    url: 'get_tags.php',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        const $tagSelect = $('#tags');
                        $tagSelect.empty(); 
                        if (response.success && response.tags.length > 0) {
                            $.each(response.tags, function(i, tag) {
                                $tagSelect.append($('<option>', {
                                    value: tag.IdTag,
                                    text: tag.Title
                                }));
                            });
                        } else {
                            $tagSelect.append($('<option>', {
                                    value: '',
                                    text: 'No tags available',
                                    disabled: true
                                }));
                        }
                        // after loading tags ensure required/disabled state is correct
                        updateTagsRequirement();
                    },
                    error: function(xhr, status, error) {
                        const $tagSelect = $('#tags');
                        $tagSelect.empty();
                        $tagSelect.append($('<option>', {
                            value: '',
                            text: 'Error loading tags',
                            disabled: true
                        }));
                        console.error("Error loading tags:", error);
                        updateTagsRequirement();
                    }
                });
            }

            /*
             * Affiche un aper√ßu c√¥t√© client de l'image s√©lectionn√©e dans l'input `#picture`.
             * Utilise FileReader pour lire le fichier et afficher son data URL.
             */
            $('#picture').change(function() {
                const file = this.files[0];
                const $preview = $('#previewImage');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $preview.attr('src', e.target.result).show();
                    }
                    reader.readAsDataURL(file);
                } else {
                    $preview.hide().attr('src', '#');
                }
            });

            /*
             * Soumet le formulaire de cr√©ation en AJAX vers `add_story.php`.
             * - Emp√™che l'envoi standard du formulaire.
             * - Valide c√¥t√© client la pr√©sence d'au moins un tag si la story n'est pas archiv√©e.
             * - Envoie les donn√©es avec `FormData` (pour inclure l'image √©ventuelle).
             * - Affiche les messages de succ√®s / erreur dans `#messageArea`.
             */
            $('#createStoryForm').on('submit', function(e) {
                e.preventDefault();
                
                const $form = $(this);
                const $btn = $form.find('button[type="submit"]');
                const $messageArea = $('#messageArea');

                $btn.prop('disabled', true).text('Publishing...');
                $messageArea.hide().removeClass('alert-success alert-danger').empty();

                // Exiger au moins un tag
                const tagsVal = $('#tags').val();
                if (!tagsVal || tagsVal.length === 0) {
                    displayMessage('Please select at least one tag.', 'alert-danger');
                    $btn.prop('disabled', false).text('üöÄ Publish Story');
                    return;
                }

                const formData = new FormData(this);

                $.ajax({
                    url: 'add_story.php',
                    type: 'POST',
                    data: formData,
                    processData: false, 
                    contentType: false, 
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            displayMessage('Story published! ID: ' + (response.story_id || ''), 'alert-success');
                            $form[0].reset(); 
                            $('#previewImage').hide().attr('src', '#');
                            loadTags(); 
                        } else {
                            displayMessage('Error: ' + (response.message || 'Unknown issue.'), 'alert-danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error:", xhr.responseText);
                        displayMessage("Communication error with server. Check logs.", 'alert-danger');
                    },
                    complete: function() {
                        $btn.prop('disabled', false).text('üöÄ Publish Story');
                    }
                });
            });

            /*
             * Affiche un message d'alerte temporaire dans la zone `#messageArea`.
             * `type` doit √™tre une classe Bootstrap telle que 'alert-success' ou 'alert-danger'.
             */
            function displayMessage(message, type) {
                const $messageArea = $('#messageArea');
                $messageArea.removeClass('alert-success alert-danger').addClass(type).text(message).show();
            }

            // Lancement des fonctions au chargement de la page
            checkAuthStatus();
            loadTags();
        });
    </script>
</body>
</html>