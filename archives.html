<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Archives - Stories</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <header class="header-top">
        <div class="logo"><img src="assets/logo_v9.png" alt="Thread Logo" class="site-logo"><span style="font-size:1.35rem; font-weight:700; color:inherit;">Thread</span></div>
        <div class="profile-menu-container">
            <img id="profileAvatar" class="profile-avatar" src="assets/ImageParDefaut.png" alt="Avatar">
            <div class="profile-dropdown" id="profileDropdown">
                <a href="login.html" id="dropdownLoginLink">üîë Connexion</a>
                <a href="register.html" id="dropdownRegisterLink">üìù S'inscrire</a>
                <div class="divider"></div>
                <a id="logoutBtn" class="logout-link">üö™ D√©connexion</a>
            </div>
        </div>
    </header>
    <nav class="navbar-main">
        <a href="index.html">Home</a>
        <a href="tags.html">Tags</a>
        <a href="create_story.html">Create</a>
        <a href="archives.html" class="active">Archives</a>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4 text-center">üóÑÔ∏è Archives des Stories</h1>
        <div id="archivesContainer" class="row">
            <p id="loadingArchives" class="text-center text-muted">Chargement des archives...</p>
        </div>
    </div>

    <!-- Modal pour afficher une archive en grand -->
    <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="archiveModalLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <div id="archiveModalImage" class="mb-3"></div>
            <div id="archiveModalContent" class="mb-3"></div>
            <div id="archiveModalTags" class="mb-2"></div>
            <div id="archiveModalMeta" class="text-muted"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(function(){
            const $container = $('#archivesContainer');
            const $loading = $('#loadingArchives');

            function loadArchives() {
                $loading.show();
                $container.empty();

                // Appelle le backend pour r√©cup√©rer les stories archiv√©es.
                // Par d√©faut on tente get_stories.php?archived=1 ‚Äî modifiez si n√©cessaire.
                $.ajax({
                    url: 'get_stories.php?archived=1',
                    method: 'GET',
                    dataType: 'json',
                    success: function(resp) {
                        $loading.hide();
                        if (resp.success && resp.stories && resp.stories.length) {
                            resp.stories.forEach(function(story){
                                // Format date JJ/MM/AAAA
                                let dateStr = '';
                                if (story.CreationDate) {
                                    const d = new Date(story.CreationDate);
                                    const day = String(d.getDate()).padStart(2, '0');
                                    const month = String(d.getMonth() + 1).padStart(2, '0');
                                    const year = d.getFullYear();
                                    dateStr = `${day}/${month}/${year}`;
                                }
                                const tagsHtml = (story.Tags || []).map(t => `<span class="badge bg-secondary tag-badge">${t}</span>`).join(' ');
                                const pictureHtml = story.Picture ? `<img src="${story.Picture}" class="card-img-top story-image" alt="Image de la story">` : '';
                                const card = `
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card story-card">
                                            ${pictureHtml}
                                            <div class="card-body">
                                                <h5 class="card-title">${story.StoryTitle}</h5>
                                                <p class="card-text">${(story.Content||'').substring(0,150)}${(story.Content||'').length>150 ? '...' : ''}</p>
                                                <div class="mb-2">${tagsHtml}</div>
                                                <p class="card-text"><small class="text-muted">Publi√© par <strong>${story.Username}</strong> le ${dateStr}</small></p>
                                                <textarea class="story-content-data" style="display:none;">${story.Content||''}</textarea>
                                                <div class="story-actions">
                                                    ${story.can_delete ? `<button class="delete-archive-btn btn btn-sm btn-outline-danger" data-story-id="${story.IdStory}">Supprimer</button>` : ''}
                                                    <button class="show-archive-btn btn btn-sm btn-outline-primary mt-2" data-story-id="${story.IdStory}">Afficher en grand</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                $container.append(card);
                            });
                        } else {
                            $container.html('<p class="text-center text-muted">Aucune archive disponible.</p>');
                        }
                    },
                    error: function(xhr) {
                        $loading.hide();
                        $container.html('<p class="text-center text-danger">Erreur de chargement des archives.</p>');
                        console.error(xhr.responseText);
                    }
                });
            }

            // suppression d'une archive (POST vers delete_archive.php)
            $container.on('click', '.delete-archive-btn', function(){
                if (!confirm('Confirmer la suppression de cette archive ?')) return;
                const $btn = $(this);
                const id = $btn.data('story-id');
                $btn.prop('disabled', true).text('Suppression...');
                $.ajax({
                    url: 'delete_archive.php',
                    method: 'POST',
                    data: { archive_id: id },
                    dataType: 'json',
                    success: function(resp){
                        if (resp.success) {
                            $btn.closest('.col-md-6, .col-lg-4').slideUp(200, function(){ $(this).remove(); });
                        } else {
                            alert(resp.message || 'Erreur lors de la suppression.');
                            $btn.prop('disabled', false).text('Supprimer');
                        }
                    },
                    error: function(){
                        alert('Erreur serveur lors de la suppression.');
                        $btn.prop('disabled', false).text('Supprimer');
                    }
                });
            });

            // Afficher une archive en grand (modal)
            $container.on('click', '.show-archive-btn', function(){
                const $card = $(this).closest('.card');
                const title = $card.find('.card-title').text();
                const content = $card.find('.story-content-data').val() || $card.find('.card-text').first().text();
                const imageHtml = $card.find('.card-img-top.story-image').length ? $card.find('.card-img-top.story-image').prop('outerHTML') : '';
                const tagsHtml = $card.find('.tag-badge').map(function(){ return $(this).prop('outerHTML'); }).get().join(' ');
                const meta = $card.find('.card-text small').html();

                $('#archiveModalLabel').text(title);
                $('#archiveModalImage').html(imageHtml);
                $('#archiveModalContent').html(`<p>${content.replace(/\n/g, '<br>')}</p>`);
                $('#archiveModalTags').html(tagsHtml);
                $('#archiveModalMeta').html(meta);

                var modal = new bootstrap.Modal(document.getElementById('archiveModal'));
                modal.show();
            });

            // menu profil simple (like other pages)
            $('#profileAvatar').on('click', function(){ $('#profileDropdown').toggle(); });
            $(document).on('click', function(e){ if(!$(e.target).closest('.profile-menu-container').length) $('#profileDropdown').hide(); });

            $('#logoutBtn').on('click', function(){ 
                if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                    $.ajax({
                        url: 'logout.php',
                        type: 'POST',
                        dataType: 'json',
                        success: function(resp){
                            if (resp.success) window.location.href = 'index.html';
                        }
                    });
                }
            });

            loadArchives();
        });
    </script>
</body>
</html>
